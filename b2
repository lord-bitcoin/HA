blueprint:
  name: Gestion automatisée des climatiseurs par saison et température
  description: >
    Automatise la gestion des climatiseurs selon la saison, les plages horaires, 
    et les températures mesurées à l'intérieur et à l'extérieur.
    Active également un mode humide si l'humidité mesurée sort des seuils définis.
    Permet de configurer un comportement spécifique pour la semaine ou le week-end.
  domain: automation

  input:
    # -- ENTITÉS ET CAPTEURS --
    climatiseur:
      name: Climatiseur
      description: Entité du climatiseur à contrôler.
      selector:
        entity:
          domain: climate

    temperature_interieur:
      name: Capteur de température intérieure
      description: Entité mesurant la température intérieure.
      selector:
        entity:
          domain: sensor
          device_class: temperature

    temperature_exterieur:
      name: Capteur de température extérieure
      description: Entité mesurant la température extérieure.
      selector:
        entity:
          domain: sensor
          device_class: temperature

    humidite_interieur:
      name: Capteur d'humidité intérieure
      description: Entité mesurant l'humidité intérieure.
      selector:
        entity:
          domain: sensor
          device_class: humidity

    # -- MODES DE CLIMATISATION PAR SAISON --
    mode_printemps:
      name: Mode de climatisation - Printemps
      description: Mode de fonctionnement du climatiseur au printemps.
      selector:
        select:
          options:
            - heat
            - cool
            - auto

    mode_ete:
      name: Mode de climatisation - Été
      description: Mode de fonctionnement du climatiseur en été.
      selector:
        select:
          options:
            - heat
            - cool
            - auto

    mode_automne:
      name: Mode de climatisation - Automne
      description: Mode de fonctionnement du climatiseur en automne.
      selector:
        select:
          options:
            - heat
            - cool
            - auto

    mode_hiver:
      name: Mode de climatisation - Hiver
      description: Mode de fonctionnement du climatiseur en hiver.
      selector:
        select:
          options:
            - heat
            - cool
            - auto

    # -- TEMPÉRATURES CIBLES PAR SAISON --
    temperature_printemps:
      name: Température cible - Printemps
      description: Température à maintenir au printemps.
      selector:
        number:
          min: 18
          max: 26
          step: 0.5
          unit_of_measurement: °C

    temperature_ete:
      name: Température cible - Été
      description: Température à maintenir en été.
      selector:
        number:
          min: 18
          max: 26
          step: 0.5
          unit_of_measurement: °C

    temperature_automne:
      name: Température cible - Automne
      description: Température à maintenir en automne.
      selector:
        number:
          min: 18
          max: 26
          step: 0.5
          unit_of_measurement: °C

    temperature_hiver:
      name: Température cible - Hiver
      description: Température à maintenir en hiver.
      selector:
        number:
          min: 18
          max: 26
          step: 0.5
          unit_of_measurement: °C

    # -- PLAGES HORAIRES --
    heure_debut_jour:
      name: Heure de début de la journée
      description: Heure de début des plages horaires de jour.
      selector:
        time:

    heure_fin_jour:
      name: Heure de fin de la journée
      description: Heure de fin des plages horaires de jour.
      selector:
        time:

    # -- PARAMÈTRES DIVERS --
    seuil_tolerance:
      name: Seuil de tolérance
      description: Marge autour de la température cible pour ajuster la climatisation.
      selector:
        number:
          min: 0
          max: 3
          step: 0.5
          unit_of_measurement: °C

    temperature_max_preservation:
      name: Température max tolérée - Mode préservation
      description: Température maximale à ne pas dépasser en mode préservation.
      selector:
        number:
          min: 20
          max: 30
          step: 0.5
          unit_of_measurement: °C

    humidite_min:
      name: Humidité minimale
      description: Seuil d'humidité minimal avant d'activer le mode humide.
      selector:
        number:
          min: 40
          max: 50
          step: 2.5
          unit_of_measurement: "%"

    humidite_max:
      name: Humidité maximale
      description: Seuil d'humidité maximal avant d'activer le mode humide.
      selector:
        number:
          min: 60
          max: 70
          step: 2.5
          unit_of_measurement: "%"

    mode_semaine_weekend:
      name: Mode semaine ou week-end
      description: Applique des réglages spécifiques pour la semaine (lundi-vendredi) ou le week-end (samedi-dimanche).
      selector:
        select:
          options:
            - semaine
            - weekend

    # -- PARAMÈTRES MODE ÉCO --
    mode_eco:
      name: Mode éco
      description: Active des paramètres d'économie d'énergie
      selector:
        boolean: {}

    delta_eco:
      name: Delta température mode éco
      description: Ajustement de température en mode éco
      selector:
        number:
          min: 1
          max: 5
          step: 0.5
          unit_of_measurement: °C

mode: single

trigger:
  - platform: state
    entity_id: !input temperature_interieur
  - platform: state
    entity_id: !input humidite_interieur
  - platform: time_pattern
    minutes: "/5"

condition:
  - condition: template
    value_template: >-
      {% if !input mode_semaine_weekend == 'semaine' %}
        {{ now().weekday() in [0,1,2,3,4] }}
      {% else %}
        {{ now().weekday() in [5,6] }}
      {% endif %}

action:
  - variables:
      date_actuelle: "{{ now() }}"
      
      saison: >-
        {% set mois = date_actuelle.month %}
        {% set jour = date_actuelle.day %}
        
        {% if (mois == 12 and jour >= 21) or (mois in [1,2]) or (mois == 3 and jour < 20) %}
          hiver
        {% elif (mois == 3 and jour >= 20) or (mois in [4,5]) or (mois == 6 and jour < 21) %}
          printemps
        {% elif (mois == 6 and jour >= 21) or (mois in [7,8]) or (mois == 9 and jour < 23) %}
          ete
        {% else %}
          automne
        {% endif %}
      
      mode_actuel: >-
        {% if saison == 'printemps' %}
          {{ !input mode_printemps }}
        {% elif saison == 'ete' %}
          {{ !input mode_ete }}
        {% elif saison == 'automne' %}
          {{ !input mode_automne }}
        {% else %}
          {{ !input mode_hiver }}
        {% endif %}

      temperature_cible: >-
        {% if saison == 'printemps' %}
          {{ !input temperature_printemps }}
        {% elif saison == 'ete' %}
          {{ !input temperature_ete }}
        {% elif saison == 'automne' %}
          {{ !input temperature_automne }}
        {% else %}
          {{ !input temperature_hiver }}
        {% endif %}

      temperature_eco: >-
        {% if !input mode_eco %}
          {% if mode_actuel == 'cool' %}
            {{ temperature_cible + !input delta_eco }}
          {% else %}
            {{ temperature_cible - !input delta_eco }}
          {% endif %}
        {% else %}
          {{ temperature_cible }}
        {% endif %}

      temperature_interieure: "{{ states(!input temperature_interieur) | float }}"
      temperature_exterieure: "{{ states(!input temperature_exterieur) | float }}"
      humidite_interieure: "{{ states(!input humidite_interieur) | float }}"

      temperature_min: >-
        {{ temperature_cible | float - (!input seuil_tolerance | float) }}
      temperature_max: >-
        {{ temperature_cible | float + (!input seuil_tolerance | float) }}

  - choose:
      # 1. Si humidité hors limites -> mode dry
      - conditions:
          - condition: template
            value_template: >-
              {{ 
                humidite_interieure < (!input humidite_min | float) or 
                humidite_interieure > (!input humidite_max | float)
              }}
        sequence:
          - service: climate.set_hvac_mode
            data:
              entity_id: !input climatiseur
              hvac_mode: "dry"

      # 2. Si température intérieure hors limites -> ajustement
      - conditions:
          - condition: template
            value_template: >-
              {{ 
                temperature_interieure > temperature_max | float or 
                temperature_interieure < temperature_min | float
              }}
        sequence:
          - service: climate.set_hvac_mode
            data:
              entity_id: !input climatiseur
              hvac_mode: "{{ mode_actuel }}"
          - service: climate.set_temperature
            data:
              entity_id: !input climatiseur
              temperature: "{{ temperature_eco | float }}"

      # 3. Si température extérieure très élevée -> mode préservation
      - conditions:
          - condition: template
            value_template: >-
              {{ temperature_exterieure > (temperature_cible | float + 7) }}
        sequence:
          - service: climate.set_hvac_mode
            data:
              entity_id: !input climatiseur
              hvac_mode: "cool"
          - service: climate.set_temperature
            data:
              entity_id: !input climatiseur
              temperature: >
                {{ [ (temperature_exterieure | float - 7), (!input temperature_max_preservation | float) ] | min }}

      # 4. Zone de confort -> maintien températures
      - conditions:
          - condition: template
            value_template: >-
              {{ 
                (humidite_interieure >= (!input humidite_min | float) + 2.5)
                and (humidite_interieure <= (!input humidite_max | float) - 2.5)
                and (temperature_interieure >= temperature_min | float)
                and (temperature_interieure <= temperature_max | float)
              }}
        sequence:
          - service: climate.set_hvac_mode
            data:
              entity_id: !input climatiseur
              hvac_mode: "{{ mode_actuel }}"
          - service: climate.set_temperature
            data:
              entity_id: !input climatiseur
              temperature: "{{ temperature_eco | float }}"
