blueprint:
  name: Gestion Climatisation avec Saison Auto et Paramètres Manuels
  description: Gère la climatisation définie avec des actions par saison et la possibilité de configurer chaque saison.
  domain: automation
  input:
    plage_horaire:
      name: Plage Horaire
      description: Jour ou Nuit.
      selector:
        select:
          options:
            - jour
            - nuit
    thermometres_intérieur:
      name: Capteurs de température (Intérieur)
      description: Capteur utilisé pour mesurer la température intérieure.
      selector:
        entity:
          domain: sensor
    thermometres_exterieur:
      name: Capteurs de température (Extérieur)
      description: Capteur utilisé pour mesurer la température extérieure.
      selector:
        entity:
          domain: sensor
    climatiseurs:
      name: Climatiseur
      description: Entité du climatiseur à contrôler.
      selector:
        entity:
          domain: climate
    temperature_printemps:
      name: Température cible (Printemps)
      description: Température à maintenir pendant le printemps.
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
    temperature_ete:
      name: Température cible (Été)
      description: Température à maintenir pendant l'été.
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
    temperature_automne:
      name: Température cible (Automne)
      description: Température à maintenir pendant l'automne.
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
    temperature_hiver:
      name: Température cible (Hiver)
      description: Température à maintenir pendant l'hiver.
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
    configurer_saison:
      name: Configurer une saison spécifique
      description: Permet de choisir une saison à configurer manuellement (facultatif).
      selector:
        select:
          options:
            - printemps
            - ete
            - automne
            - hiver
            - automatique
      default: automatique
    heure_debut_jour:
      name: Heure début jour
      description: Heure à laquelle commence la plage horaire jour.
      selector:
        time:
    heure_fin_jour:
      name: Heure fin jour
      description: Heure à laquelle se termine la plage horaire jour.
      selector:
        time:
    seuil_tolerance:
      name: Seuil de tolérance
      description: Ajustement à appliquer autour de la température cible pour déclencher la climatisation.
      selector:
        number:
          min: 0
          max: 3
          step: 0.5
    temperature_max_preservation:
      name: Température maximum pour le mode préservation
      description: Température maximale cible lors du mode préservation.
      selector:
        number:
          min: 15
          max: 30
          step: 0.5

trigger:
  - platform: state
    entity_id: !input thermometres_intérieur

variables:
  current_date: "{{ now().date() }}"
  saison_auto: >
    {% if current_date >= now().replace(month=3, day=21).date() and current_date < now().replace(month=6, day=21).date() %}
      'printemps'
    {% elif current_date >= now().replace(month=6, day=21).date() and current_date < now().replace(month=9, day=21).date() %}
      'ete'
    {% elif current_date >= now().replace(month=9, day=21).date() and current_date < now().replace(month=12, day=21).date() %}
      'automne'
    {% else %}
      'hiver'
    {% endif %}
  saison: >
    {{ !input configurer_saison if !input configurer_saison != 'automatique' else saison_auto }}
  temperature_cible: >
    {{ {
      'printemps': !input temperature_printemps,
      'ete': !input temperature_ete,
      'automne': !input temperature_automne,
      'hiver': !input temperature_hiver
    }[saison] }}
  temperature_min: >
    {{ temperature_cible - !input seuil_tolerance }}
  temperature_max: >
    {{ temperature_cible + !input seuil_tolerance }}
  hvac_mode: >
    {{ 'cool' if saison in ['printemps', 'ete'] else 'heat' }}

action:
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input thermometres_intérieur
                below: temperature_min
              - condition: numeric_state
                entity_id: !input thermometres_intérieur
                above: temperature_max
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input climatiseurs
            data:
              hvac_mode: "{{ hvac_mode }}"
          - service: climate.set_temperature
            target:
              entity_id: !input climatiseurs
            data:
              temperature: temperature_cible
      - conditions:
          - condition: template
            value_template: >
              {{ (states(!input thermometres_exterieur) | float) - 7 > temperature_cible }}
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input climatiseurs
            data:
              hvac_mode: cool
          - service: climate.set_temperature
            target:
              entity_id: !input climatiseurs
            data:
              temperature: >
                {{ [(states(!input thermometres_exterieur) | float) - 7, !input temperature_max_preservation] | min }}
mode: single
